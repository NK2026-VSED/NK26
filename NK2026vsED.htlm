<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1, user-scalable=no" />
  <title>Nathalie K contre l'extrême droite</title>
  <style>
    html, body { margin:0; padding:0; background:#0f1220; color:#fff; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .wrap { display:flex; justify-content:center; align-items:center; min-height:100vh; padding:12px; box-sizing:border-box; }
    canvas { background: linear-gradient(#6fb1ff, #cfe6ff); border-radius:18px; box-shadow: 0 10px 40px rgba(0,0,0,.35); display:block; max-width:100%; height:auto; touch-action: none; }

    /* HUD : sans transparence */
    .hud{
      position: fixed; top: 10px; left: 10px; right: 10px;
      display:flex; justify-content:space-between; gap:8px; pointer-events:none;
      font-weight:950;
      z-index: 5;
    }
    .pill{
      background: #141a2c;
      border: 2px solid #2a3357;
      padding:8px 12px;
      border-radius:999px;
      color:#fff;
      box-shadow: 0 10px 18px rgba(0,0,0,.25);
      text-shadow:none;
    }

    /* Ecran d'accueil : plein, net, sans transparence */
    .overlay{
      position: fixed; inset: 0;
      display:flex; justify-content:center; align-items:center;
      background:#0f1220;
      padding:16px;
      box-sizing:border-box;
      z-index: 10;
    }
    .card{
      width: min(920px, 100%);
      background:#141a2c;
      border: 2px solid #2a3357;
      border-radius: 22px;
      padding: 18px;
      box-shadow: 0 18px 70px rgba(0,0,0,.45);
      position: relative;
      overflow: hidden;
    }

    /* Bandes couleur (pleines, lisibles) */
    .bands{ position:absolute; inset: 0; pointer-events:none; }
    .band{ position:absolute; height: 66px; border-radius: 14px; }
    .b1{ left: 30px; top: 80px;  width: 78%; background:#d12b7c; }
    .b2{ left: 70px; top: 150px; width: 82%; background:#8bbf2a; }
    .b3{ left: 110px; top: 220px; width: 88%; background:#ffd400; }
    .b4{ left: 150px; top: 290px; width: 72%; background:#f39b2b; }

    .heroGrid{
      display:grid;
      grid-template-columns: 1.2fr 0.8fr;
      gap: 14px;
      align-items: stretch;
      position: relative;
    }
    @media (max-width: 780px){ .heroGrid{ grid-template-columns: 1fr; } }

    .titleKicker{
      display:inline-block;
      font-weight: 950;
      letter-spacing: .08em;
      text-transform: uppercase;
      font-size: 12px;
      color:#0f1220;
      background:#ffffff;
      padding: 6px 10px;
      border-radius: 999px;
      margin-bottom: 10px;
    }
    h1{
      margin:0 0 10px;
      font-size: 28px;
      line-height:1.08;
      color:#ffffff;
      text-shadow:none;
    }
    .subtitle{
      margin:0 0 10px;
      color:#dbe4ff;
      font-weight: 700;
    }

    ul{ margin: 10px 0 12px 18px; color:#ffffff; }
    p{ margin: 8px 0; line-height: 1.35; color:#ffffff; }
    kbd{
      display:inline-block; padding:2px 7px; border-radius:6px;
      border: 2px solid #2a3357; background:#0f1220;
      font-weight:950; font-size: 12px;
    }

    .btnRow{ display:flex; gap:10px; flex-wrap:wrap; margin-top: 12px; }
    button{
      appearance:none; border:0; border-radius:14px; padding:12px 16px;
      background:#ffffff; color:#0f1220; font-weight:950; cursor:pointer;
      box-shadow: 0 10px 20px rgba(0,0,0,.25);
    }
    button.secondary{
      background:#0f1220; color:#fff;
      border: 2px solid #2a3357;
      box-shadow:none;
    }

    /* “Portrait” à droite : fond plein */
    .portraitCard{
      position: relative;
      border-radius: 18px;
      border: 2px solid #2a3357;
      background:#0f1220;
      overflow:hidden;
      padding: 10px;
      min-height: 240px;
    }
    .portraitLabel{
      position:absolute; left: 12px; bottom: 10px;
      font-weight: 950;
      background:#141a2c;
      border: 2px solid #2a3357;
      border-radius: 999px;
      padding: 6px 10px;
      color:#fff;
    }

    /* Contrôles mobiles */
    .touchUI{ position: fixed; inset: 0; pointer-events:none; z-index: 6; }
    .touchPadLeft{ position:absolute; left: 10px; bottom: 14px; display:flex; gap:10px; pointer-events:auto; }
    .touchPadRight{ position:absolute; right: 10px; bottom: 14px; pointer-events:auto; }
    .touchBtn{
      width: 70px; height: 70px;
      border-radius: 18px;
      background: #141a2c;
      border: 2px solid #2a3357;
      display:flex; align-items:center; justify-content:center;
      font-weight: 950;
      user-select:none; -webkit-user-select:none;
      touch-action:none;
      box-shadow: 0 10px 18px rgba(0,0,0,.25);
    }
    .touchBtn:active{ transform: scale(0.98); }
    .touchHint{
      position:absolute; left: 50%; transform: translateX(-50%);
      bottom: 102px;
      background:#141a2c;
      border: 2px solid #2a3357;
      padding: 6px 10px; border-radius: 999px;
      font-weight: 950; font-size: 12px;
      pointer-events:none;
      color:#fff;
      box-shadow: 0 10px 18px rgba(0,0,0,.25);
    }
    @media (min-width: 980px){ .touchUI{ display:none; } }
  </style>
</head>

<body>
  <div class="hud">
    <div class="pill" id="scorePill">Score : 0</div>
    <div class="pill" id="midPill">Niveau : 1 • Temps : 0:00</div>
    <div class="pill" id="rightPill">Vies : 3 • Record : 0</div>
  </div>

  <div class="wrap">
    <canvas id="game" width="960" height="540"></canvas>
  </div>

  <div class="touchUI" id="touchUI">
    <div class="touchHint">Contrôles tactiles actifs</div>
    <div class="touchPadLeft">
      <div class="touchBtn" id="btnLeft">◀</div>
      <div class="touchBtn" id="btnRight">▶</div>
    </div>
    <div class="touchPadRight">
      <div class="touchBtn" id="btnJump">⤒</div>
    </div>
  </div>

  <div class="overlay" id="overlay">
    <div class="card">
      <div class="bands" aria-hidden="true">
        <div class="band b1"></div>
        <div class="band b2"></div>
        <div class="band b3"></div>
        <div class="band b4"></div>
      </div>

      <div class="heroGrid">
        <div>
          <div class="titleKicker">JEU 2D • DIJON</div>
          <h1 id="overlayTitle">Nathalie K contre l'extrême droite</h1>
          <p class="subtitle" id="overlayLine">
            Saute sur Manu (lunettes) et Titi (cigare) pour marquer des points. Plus tu joues, plus ça accélère.
          </p>

          <ul>
            <li>PC : <kbd>←</kbd> <kbd>→</kbd> (ou <kbd>A</kbd> <kbd>D</kbd>) • saut <kbd>Espace</kbd> (ou <kbd>W</kbd> / <kbd>↑</kbd>)</li>
            <li>Téléphone : boutons ◀ ▶ et ⤒</li>
            <li>Écraser par le dessus : +100 (bonus combo)</li>
            <li>Toucher par le côté : -1 vie</li>
          </ul>

          <div class="btnRow">
            <button id="startBtn">Jouer</button>
            <button class="secondary" id="fsBtn">Plein écran</button>
            <button class="secondary" id="howBtn">Rappel commandes</button>
          </div>
        </div>

        <div class="portraitCard" aria-hidden="true">
          <canvas id="portrait" width="360" height="300" style="width:100%; height:auto; border-radius:14px; background:#0f1220;"></canvas>
          <div class="portraitLabel">Nathalie</div>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  const canvas = document.getElementById("game");
  const ctx = canvas.getContext("2d");

  const portraitCanvas = document.getElementById("portrait");
  const pctx = portraitCanvas.getContext("2d");

  const scorePill = document.getElementById("scorePill");
  const midPill = document.getElementById("midPill");
  const rightPill = document.getElementById("rightPill");

  const overlay = document.getElementById("overlay");
  const overlayTitle = document.getElementById("overlayTitle");
  const overlayLine = document.getElementById("overlayLine");
  const startBtn = document.getElementById("startBtn");
  const howBtn = document.getElementById("howBtn");
  const fsBtn = document.getElementById("fsBtn");

  const btnLeft = document.getElementById("btnLeft");
  const btnRight = document.getElementById("btnRight");
  const btnJump = document.getElementById("btnJump");
  const touchUI = document.getElementById("touchUI");

  // Audio (WebAudio simple)
  let audioCtx = null;
  function ensureAudio() {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (audioCtx.state === "suspended") audioCtx.resume().catch(()=>{});
  }
  function beep({freq=440, dur=0.08, type="sine", gain=0.05}) {
    if (!audioCtx) return;
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = type; o.frequency.value = freq; g.gain.value = gain;
    o.connect(g); g.connect(audioCtx.destination);
    o.start(); o.stop(audioCtx.currentTime + dur);
  }
  const sfx = {
    jump(){ beep({freq: 560, dur: 0.06, type:"square", gain:0.035}); beep({freq: 740, dur: 0.05, type:"square", gain:0.02}); },
    stomp(){ beep({freq: 220, dur: 0.07, type:"sawtooth", gain:0.045}); },
    hurt(){ beep({freq: 140, dur: 0.12, type:"triangle", gain:0.06}); },
    level(){ beep({freq: 660, dur: 0.07, type:"sine", gain:0.05}); beep({freq: 880, dur: 0.07, type:"sine", gain:0.04}); },
    over(){ beep({freq: 180, dur: 0.18, type:"triangle", gain:0.06}); }
  };

  // Monde
  const W = canvas.width, H = canvas.height;
  const GRAVITY = 2350;

  // Vitesse Nathalie (augmentée)
  const MOVE_SPEED = 980;     // <-- augmenté
  const JUMP_SPEED = 980;     // léger ajustement pour suivre la vitesse
  const FRICTION = 0.86;

  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const aabb=(A,B)=>A.x<B.x+B.w&&A.x+A.w>B.x&&A.y<B.y+B.h&&A.y+A.h>B.y;

  function resolveTopCollision(entity, plat){
    const prevBottom = entity.prevY + entity.h;
    const bottom = entity.y + entity.h;
    const wasAbove = prevBottom <= plat.y + 2;
    if (aabb(entity, plat) && wasAbove && bottom >= plat.y){
      entity.y = plat.y - entity.h;
      entity.vy = 0;
      entity.onGround = true;
      return true;
    }
    return false;
  }

  // Scrolling
  let camX=0;
  const groundY=440;

  const platforms=[];
  function addPlatform(x,y,w,h){ platforms.push({x,y,w,h}); }

  function initPlatforms(){
    platforms.length=0;
    for(let i=0;i<12;i++) addPlatform(i*420, groundY, 420, 140);
    // Moins de plateformes “étages”
    addPlatform(360, 345, 240, 22);
    addPlatform(860, 315, 240, 22);
    addPlatform(1360, 360, 220, 22);
  }

  let nextGenX=2100;
  function generateAhead(){
    const needUntil = camX + W + 1200;

    const lastGround = platforms.filter(p=>p.y===groundY&&p.h>=100)
      .sort((a,b)=>(a.x+a.w)-(b.x+b.w)).at(-1);

    let groundEnd = lastGround ? (lastGround.x+lastGround.w) : 0;
    while(groundEnd<needUntil){
      addPlatform(groundEnd, groundY, 420, 140);
      groundEnd += 420;
    }

    // Moins d'étages : génération plus rare + hauteur limitée
    while(nextGenX<needUntil){
      if (Math.random() < 0.55) {
        nextGenX += 360 + Math.random()*260;
        continue;
      }
      const w = 230 + Math.random()*80;
      const y = Math.random() < 0.6 ? 360 : 325; // seulement 2 hauteurs
      addPlatform(nextGenX, y, w, 22);
      nextGenX += 520 + Math.random()*340;
    }

    const minKeepX = camX - 650;
    for(let i=platforms.length-1;i>=0;i--){
      if (platforms[i].x + platforms[i].w < minKeepX) platforms.splice(i,1);
    }
  }

  // Joueur
  const PLAYER_SCALE = 1.22;
  const player={
    x:110, y:120,
    w:50, h:68,
    vx:0, vy:0,
    onGround:false,
    prevY:120,
    invuln:0,
    combo:0, comboT:0
  };

  // Ennemis
  function makeEnemy(type,x,y,baseSpeed){
    return { type,x,y,w:52,h:70,vx:-baseSpeed,vy:0,onGround:false,prevY:y,bob:Math.random()*Math.PI*2 };
  }
  const enemies=[];
  let spawnTimer=0;

  // Progression
  let score=0,lives=3,running=false,gameOver=false;
  let elapsed=0,level=1;
  const bestKey="dijon_jump_best_v4";
  let best=Number(localStorage.getItem(bestKey)||"0");

  function formatTime(sec){
    const s=Math.max(0,Math.floor(sec));
    const m=Math.floor(s/60), r=s%60;
    return m+":"+String(r).padStart(2,"0");
  }
  function difficulty(){
    const enemySpeed = 165 + (level-1)*22;
    const spawnEvery = Math.max(0.55, 1.10 - (level-1)*0.08);
    const maxEnemies = Math.min(12, 4 + Math.floor((level-1)*0.9));
    return {enemySpeed,spawnEvery,maxEnemies};
  }
  function updateHUD(){
    scorePill.textContent="Score : "+score;
    midPill.textContent=`Niveau : ${level} • Temps : ${formatTime(elapsed)}`;
    rightPill.textContent=`Vies : ${lives} • Record : ${best}`;
  }

  function resetGame(){
    score=0; lives=3; elapsed=0; level=1; gameOver=false;
    player.x=110; player.y=120; player.vx=0; player.vy=0;
    player.invuln=0; player.combo=0; player.comboT=0;
    camX=0; enemies.length=0; spawnTimer=0;
    initPlatforms(); nextGenX=2100;
    const d=difficulty();
    enemies.push(makeEnemy("manu", 780, 120, d.enemySpeed));
    enemies.push(makeEnemy("titi", 1020, 120, d.enemySpeed-8));
    updateHUD();
  }

  // Input clavier
  const keysDown=new Set();
  const keysPressed=new Set();
  function keyToken(e){ return e.code==="Space" ? "Space" : e.key; }
  window.addEventListener("keydown",(e)=>{
    const k=keyToken(e);
    if(["Space","ArrowUp","ArrowLeft","ArrowRight"].includes(k)) e.preventDefault();
    if(!keysDown.has(k)) keysPressed.add(k);
    keysDown.add(k);
  },{passive:false});
  window.addEventListener("keyup",(e)=>keysDown.delete(keyToken(e)));
  const isDown=(...ks)=>ks.some(k=>keysDown.has(k));
  const wasPressed=(...ks)=>ks.some(k=>keysPressed.has(k));

  // Tactile
  const touchState={left:false,right:false,jumpPressed:false};
  function bindHold(btn,onDown,onUp){
    const down=(ev)=>{ev.preventDefault(); ensureAudio(); onDown();};
    const up=(ev)=>{ev.preventDefault(); onUp();};
    btn.addEventListener("pointerdown",down);
    btn.addEventListener("pointerup",up);
    btn.addEventListener("pointercancel",up);
    btn.addEventListener("pointerleave",up);
  }
  bindHold(btnLeft, ()=>touchState.left=true, ()=>touchState.left=false);
  bindHold(btnRight,()=>touchState.right=true,()=>touchState.right=false);
  btnJump.addEventListener("pointerdown",(ev)=>{ev.preventDefault(); ensureAudio(); touchState.jumpPressed=true;});

  // Overlay
  function showTutorial(){
    overlayTitle.textContent="Nathalie K contre l'extrême droite";
    overlayLine.textContent="Saute sur Manu (lunettes) et Titi (cigare) pour marquer des points. Plus tu joues, plus ça accélère.";
    startBtn.textContent="Jouer";
    overlay.style.display="flex";
  }
  startBtn.addEventListener("click",()=>{
    ensureAudio();
    overlay.style.display="none";
    if(gameOver) resetGame();
    running=true;
  });
  howBtn.addEventListener("click",()=>{
    overlayLine.textContent="PC : ←/→ (ou A/D) • saut Espace (ou W/↑). Téléphone : ◀ ▶ ⤒.";
  });
  fsBtn.addEventListener("click", async ()=>{
    ensureAudio();
    try{
      if(!document.fullscreenElement) await document.documentElement.requestFullscreen();
      else await document.exitFullscreen();
    }catch(e){}
  });

  // Draw helpers
  function roundRect(g, x,y,w,h,r){
    g.beginPath();
    g.moveTo(x+r,y);
    g.arcTo(x+w,y,x+w,y+h,r);
    g.arcTo(x+w,y+h,x,y+h,r);
    g.arcTo(x,y+h,x,y,r);
    g.arcTo(x,y,x+w,y,r);
    g.closePath();
  }

  function drawDijonBackdrop(){
    // Soleil
    ctx.save();
    ctx.globalAlpha=0.9;
    ctx.beginPath();
    ctx.arc(130-camX*0.04,92,40,0,Math.PI*2);
    ctx.fillStyle="rgba(255,255,255,.65)";
    ctx.fill();
    ctx.restore();

    // Bandes couleur (dans le décor)
    const bands=[
      {x:120,y:110,w:720,h:66,c:"#d12b7c",k:0.06},
      {x:170,y:190,w:760,h:66,c:"#8bbf2a",k:0.07},
      {x:220,y:270,w:820,h:66,c:"#ffd400",k:0.08},
      {x:270,y:350,w:650,h:66,c:"#f39b2b",k:0.09},
    ];
    for(const b of bands){
      const px=b.x - (camX*b.k % 240);
      roundRect(ctx, px, b.y, b.w, b.h, 16);
      ctx.fillStyle=b.c;
      ctx.fill();
    }

    // Collines
    function hill(y,amp,freq,alpha){
      ctx.save();
      ctx.globalAlpha=alpha;
      ctx.beginPath();
      ctx.moveTo(0,y);
      for(let x=0;x<=W;x+=18){
        const wx=x+camX*0.10;
        const yy=y+Math.sin(wx*freq)*amp;
        ctx.lineTo(x,yy);
      }
      ctx.lineTo(W,H); ctx.lineTo(0,H); ctx.closePath();
      ctx.fillStyle="rgba(20,30,60,.35)";
      ctx.fill();
      ctx.restore();
    }
    hill(260,16,0.010,0.16);
    hill(300,20,0.012,0.12);

    // Silhouette
    ctx.save();
    ctx.globalAlpha=0.22;
    ctx.fillStyle="rgba(10,14,30,1)";
    const baseY=330;
    for(let i=0;i<28;i++){
      const bx=(i*54) - (camX*0.18 % 54);
      const bw=40+(i%3)*10;
      const bh=28+(i%6)*16;
      ctx.fillRect(bx, baseY-bh, bw, bh);
      ctx.beginPath();
      ctx.moveTo(bx, baseY-bh);
      ctx.lineTo(bx+bw/2, baseY-bh-12);
      ctx.lineTo(bx+bw, baseY-bh);
      ctx.closePath();
      ctx.fill();
    }
    ctx.restore();

    // DIJON. (avec point) — et suppression de toute mention "décor stylé"
    ctx.save();
    ctx.font="1000 34px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    ctx.fillStyle="rgba(15,18,32,.90)";
    ctx.fillText("Dijon.", 22, 48);
    ctx.restore();
  }

  function drawPlatforms(){
    for(const p of platforms){
      const sx=p.x-camX;
      if(sx+p.w<-90 || sx>W+90) continue;
      const isGround=(p.y===groundY && p.h>=100);
      ctx.fillStyle=isGround ? "rgba(35,110,70,.95)" : "rgba(35,110,70,.75)";
      ctx.fillRect(sx,p.y,p.w,p.h);
      ctx.fillStyle="rgba(15,18,32,.22)";
      ctx.fillRect(sx,p.y,p.w,6);
    }
  }

  function drawFaceDetails(g, cx, cy, opts){
    const {mood="smile", glasses=false, cigar=false, eyeColor="#2d74ff"} = opts || {};
    g.save();
    // sourcils
    g.strokeStyle="rgba(0,0,0,.45)";
    g.lineWidth=2;
    g.beginPath();
    g.moveTo(cx-10, cy-2); g.quadraticCurveTo(cx-4, cy-7, cx+2, cy-2);
    g.moveTo(cx+3,  cy-2); g.quadraticCurveTo(cx+9, cy-7, cx+14, cy-2);
    g.stroke();

    // yeux
    g.fillStyle=eyeColor;
    g.beginPath(); g.arc(cx-6, cy+4, 2.0, 0, Math.PI*2); g.fill();
    g.beginPath(); g.arc(cx+8, cy+4, 2.0, 0, Math.PI*2); g.fill();
    g.fillStyle="rgba(0,0,0,.55)";
    g.beginPath(); g.arc(cx-6, cy+4, 1.0, 0, Math.PI*2); g.fill();
    g.beginPath(); g.arc(cx+8, cy+4, 1.0, 0, Math.PI*2); g.fill();

    // nez
    g.strokeStyle="rgba(0,0,0,.22)";
    g.lineWidth=2;
    g.beginPath();
    g.moveTo(cx+2, cy+5);
    g.quadraticCurveTo(cx, cy+10, cx+3, cy+12);
    g.stroke();

    // bouche
    g.strokeStyle="rgba(120,40,55,.60)";
    g.lineWidth=2;
    g.beginPath();
    if(mood==="smile"){
      g.moveTo(cx-10, cy+17);
      g.quadraticCurveTo(cx+1, cy+23, cx+14, cy+17);
    }else{
      g.moveTo(cx-10, cy+19);
      g.quadraticCurveTo(cx+2, cy+17, cx+14, cy+19);
    }
    g.stroke();

    if(glasses){
      g.strokeStyle="rgba(0,0,0,.62)";
      g.lineWidth=2;
      g.strokeRect(cx-15, cy+2, 12, 8);
      g.strokeRect(cx+1,  cy+2, 12, 8);
      g.beginPath(); g.moveTo(cx-3, cy+6); g.lineTo(cx+1, cy+6); g.stroke();
    }
    if(cigar){
      g.fillStyle="#b07b44";
      g.fillRect(cx+12, cy+18, 14, 3);
      g.strokeStyle="rgba(255,255,255,.55)";
      g.lineWidth=2;
      g.beginPath();
      g.moveTo(cx+26, cy+17);
      g.bezierCurveTo(cx+36, cy+8, cx+24, cy+3, cx+36, cy-2);
      g.stroke();
    }
    g.restore();
  }

  // Nathalie : écharpe plus petite, bien placée (une fois pour toutes)
  function drawNathalie(g, px, py, scale=1){
    g.save();
    g.translate(px, py);
    g.scale(scale, scale);

    const w=50, h=68;

    // Ombre
    g.fillStyle="rgba(0,0,0,.18)";
    g.beginPath(); g.ellipse(w/2, h+6, 24, 9, 0, 0, Math.PI*2); g.fill();

    // Cou
    g.fillStyle="#f2d6c7";
    g.fillRect(25, 28, 8, 8);

    // Tête
    g.beginPath(); g.ellipse(29, 18, 16.5, 17, 0, 0, Math.PI*2); g.fill();

    // Cheveux
    g.fillStyle="#f2cf63";
    g.beginPath(); g.ellipse(29, 12.5, 18.5, 12.5, 0, 0, Math.PI*2); g.fill();
    g.fillStyle="#eac25a";
    g.beginPath(); g.ellipse(21, 18, 7.8, 10.8, 0.35, 0, Math.PI*2); g.fill();
    g.fillStyle="#f4d35e";
    g.beginPath(); g.ellipse(48, 23, 12.5, 7.5, 0.28, 0, Math.PI*2); g.fill();

    // Visage
    drawFaceDetails(g, 29, 12, {mood:"smile", eyeColor:"#2d74ff"});

    // T-shirt
    g.fillStyle="#ffffff";
    g.fillRect(14, 36, 30, 26);

    // Veste
    g.fillStyle="#0f0f12";
    g.fillRect(9, 36, 15, 26);
    g.fillRect(34, 36, 15, 26);
    g.fillStyle="rgba(255,255,255,.10)";
    g.beginPath(); g.moveTo(24, 36); g.lineTo(18, 48); g.lineTo(24, 62); g.closePath(); g.fill();
    g.beginPath(); g.moveTo(34, 36); g.lineTo(40, 48); g.lineTo(34, 62); g.closePath(); g.fill();

    // Écharpe — plus petite et plus basse (jamais sur la tête)
    g.save();
    g.translate(12, 44);
    g.rotate(-0.42);

    // petit fond fin
    g.fillStyle="rgba(15,18,32,.22)";
    roundRect(g, 10, 0, 28, 38, 7);
    g.fill();

    // tricolore (fin)
    g.fillStyle="#2b67ff"; roundRect(g, 11, 1, 9, 36, 6); g.fill();
    g.fillStyle="#ffffff"; roundRect(g, 20, 1, 9, 36, 6); g.fill();
    g.fillStyle="#e23b3b"; roundRect(g, 29, 1, 9, 36, 6); g.fill();

    g.restore();

    // Jambes
    g.fillStyle="#1d243d";
    g.fillRect(16, 62, 12, 10);
    g.fillRect(34, 62, 12, 10);

    g.restore();
  }

  function drawEnemy(g, e){
    const px=e.x, py=e.y;
    g.save();
    g.translate(px, py + Math.sin(e.bob)*1.2);

    // Ombre
    g.fillStyle="rgba(0,0,0,.18)";
    g.beginPath(); g.ellipse(e.w/2, e.h+6, 24, 9, 0, 0, Math.PI*2); g.fill();

    // Cou + tête
    g.fillStyle="#e8c9b5";
    g.fillRect(27, 29, 8, 8);
    g.beginPath(); g.ellipse(31, 18, 17, 17, 0, 0, Math.PI*2); g.fill();

    // Cheveux
    g.fillStyle="#2a2a2a";
    g.beginPath(); g.ellipse(31, 12, 19, 11.5, 0, 0, Math.PI*2); g.fill();

    // Visage
    drawFaceDetails(g, 31, 12, { mood:"flat", glasses: e.type==="manu", cigar: e.type==="titi", eyeColor:"#1b3b7a" });

    // Costume + chemise
    g.fillStyle="#1c2236";
    g.fillRect(12, 36, 38, 26);
    g.fillStyle="rgba(255,255,255,.12)";
    g.fillRect(25, 36, 12, 10);

    // Cravate
    g.fillStyle = (e.type==="manu") ? "#7aa2ff" : "#ff7aa2";
    g.beginPath();
    g.moveTo(31, 46);
    g.lineTo(27, 60);
    g.lineTo(35, 60);
    g.closePath();
    g.fill();

    // Jambes
    g.fillStyle="#0f1324";
    g.fillRect(16, 64, 12, 10);
    g.fillRect(36, 64, 12, 10);

    // Nom du méchant — BLANC, GROS, très lisible
    const label = (e.type==="manu") ? "MANU" : "TITI";
    g.font="1000 16px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    g.fillStyle="#ffffff";
    g.strokeStyle="rgba(0,0,0,.70)";
    g.lineWidth=4;
    g.strokeText(label, 8, 90);
    g.fillText(label, 8, 90);

    g.restore();
  }

  function drawPortrait(){
    pctx.clearRect(0,0,portraitCanvas.width, portraitCanvas.height);
    // Nathalie grande dans le cadre
    pctx.save();
    pctx.translate(60, 30);
    drawNathalie(pctx, 0, 0, 2.45);
    pctx.restore();
    pctx.strokeStyle="#2a3357";
    pctx.lineWidth=3;
    pctx.strokeRect(2,2,portraitCanvas.width-4,portraitCanvas.height-4);
  }

  // Gameplay
  function spawnEnemy(){
    const d=difficulty();
    if(enemies.length>=d.maxEnemies) return;
    const type=Math.random()<0.55?"manu":"titi";
    const x=camX+W+150+Math.random()*280;
    const y=120;
    const baseSpeed=d.enemySpeed + (type==="manu"?14:6) + Math.random()*18;
    enemies.push(makeEnemy(type,x,y,baseSpeed));
  }

  function loseLife(){
    if(player.invuln>0 || gameOver) return;
    lives -= 1;
    player.invuln = 1.1;
    player.combo=0; player.comboT=0;
    ensureAudio(); sfx.hurt();

    if(lives<=0){
      gameOver=true; running=false;
      if(score>best){ best=score; localStorage.setItem(bestKey,String(best)); }
      updateHUD(); sfx.over();
      overlayTitle.textContent="Partie terminée";
      overlayLine.textContent=`Score final : ${score}.`;
      startBtn.textContent="Rejouer";
      overlay.style.display="flex";
    } else updateHUD();
  }

  function stompEnemy(idx){
    const base=100;
    player.combo += 1;
    player.comboT = 1.0;
    const bonus = Math.min(220, (player.combo-1)*25);
    score += (base + bonus);
    ensureAudio(); sfx.stomp();
    player.vy = -600;
    enemies.splice(idx,1);

    if(score>best){ best=score; localStorage.setItem(bestKey,String(best)); }
    updateHUD();
  }

  function update(dt){
    elapsed += dt;
    const newLevel = 1 + Math.floor(elapsed/20);
    if(newLevel!==level){ level=newLevel; ensureAudio(); sfx.level(); }

    generateAhead();

    const d=difficulty();
    spawnTimer += dt;
    while(spawnTimer>=d.spawnEvery){
      spawnTimer -= d.spawnEvery;
      spawnEnemy();
    }

    if(player.comboT>0){
      player.comboT -= dt;
      if(player.comboT<=0) player.combo=0;
    }

    const left = isDown("ArrowLeft","a","A") || touchState.left;
    const right= isDown("ArrowRight","d","D") || touchState.right;
    const jumpPressed = wasPressed("Space","ArrowUp","w","W") || touchState.jumpPressed;
    touchState.jumpPressed=false;

    player.prevY = player.y;
    player.onGround=false;
    if(player.invuln>0) player.invuln=Math.max(0, player.invuln-dt);

    if(left) player.vx -= MOVE_SPEED*dt;
    if(right) player.vx += MOVE_SPEED*dt;
    player.vx *= FRICTION;
    player.vx = clamp(player.vx, -MOVE_SPEED, MOVE_SPEED);

    player.vy += GRAVITY*dt;
    player.x += player.vx*dt;
    player.y += player.vy*dt;

    for(const p of platforms){
      if(p.x-camX>W+220 || p.x-camX<-520) continue;
      if(resolveTopCollision(player, {x:p.x,y:p.y,w:p.w,h:p.h})) break;
    }

    if(jumpPressed && player.onGround){
      ensureAudio(); sfx.jump();
      player.vy = -JUMP_SPEED;
      player.onGround=false;
    }

    camX = Math.max(0, player.x - 240);

    if(player.y>H+190){
      loseLife();
      player.x = camX + 110;
      player.y = 120;
      player.vx = 0;
      player.vy = 0;
    }

    for(let i=enemies.length-1;i>=0;i--){
      const e=enemies[i];
      e.prevY = e.y;
      e.onGround=false;
      e.bob += dt*6;

      e.vy += GRAVITY*dt;
      e.x += e.vx*dt;
      e.y += e.vy*dt;

      for(const p of platforms){
        if(p.x-camX>W+240 || p.x-camX<-560) continue;
        if(resolveTopCollision(e, {x:p.x,y:p.y,w:p.w,h:p.h})) break;
      }

      if(e.x < camX - 260){
        enemies.splice(i,1);
        continue;
      }

      if(aabb({x:player.x,y:player.y,w:player.w,h:player.h},{x:e.x,y:e.y,w:e.w,h:e.h})){
        const falling = player.vy>160;
        const cameFromAbove = (player.prevY + player.h) <= (e.y + 10);
        if(falling && cameFromAbove) stompEnemy(i);
        else loseLife();
      }
    }

    keysPressed.clear();

    const smallScreen = window.matchMedia("(max-width: 980px)").matches;
    touchUI.style.display = smallScreen ? "block" : "none";
  }

  function draw(){
    ctx.clearRect(0,0,W,H);

    drawDijonBackdrop();
    drawPlatforms();

    for(const e of enemies){
      const sx=e.x-camX;
      if(sx<-140 || sx>W+140) continue;
      drawEnemy(ctx, {...e, x:sx, y:e.y});
    }

    // Nathalie agrandie à l’écran
    ctx.save();
    if(player.invuln>0) ctx.globalAlpha = (Math.sin(performance.now()/85)>0 ? 0.5 : 1);
    drawNathalie(ctx, player.x-camX, player.y, PLAYER_SCALE);
    ctx.restore();

    if(player.combo>=2){
      ctx.fillStyle="#141a2c";
      ctx.strokeStyle="#2a3357";
      ctx.lineWidth=2;
      ctx.beginPath();
      if (ctx.roundRect) ctx.roundRect(16, 78, 280, 38, 14);
      else ctx.rect(16,78,280,38);
      ctx.fill();
      ctx.stroke();
      ctx.fillStyle="#fff";
      ctx.font="1000 14px system-ui, -apple-system, Segoe UI, Roboto, Arial";
      ctx.fillText("Combo x"+player.combo, 28, 103);
    }

    if(!running && !gameOver){
      ctx.fillStyle="#141a2c";
      ctx.fillRect(0,0,W,60);
      ctx.fillStyle="#fff";
      ctx.font="1000 16px system-ui, -apple-system, Segoe UI, Roboto, Arial";
      ctx.fillText("Pause — clique sur Jouer pour reprendre", 18, 38);
    }
  }

  // Loop
  let last=performance.now();
  function loop(now){
    const dt=Math.min(0.033,(now-last)/1000);
    last=now;
    if(running) update(dt);
    draw();
    requestAnimationFrame(loop);
  }

  canvas.addEventListener("pointerdown", ()=>{ ensureAudio(); if(!running && !gameOver) showTutorial(); });

  // Init
  resetGame();
  updateHUD();
  drawPortrait();
  showTutorial();
  requestAnimationFrame(loop);
})();
</script>
</body>
</html>
